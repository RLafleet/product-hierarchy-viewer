<div class="hierarchy-page">
  <header class="page-hero">
    <div class="hero-copy">
      <span class="hero-kicker">Дерево составов</span>
      <h1>Критичные детали и их ветки</h1>
      <p>Цехи → машины → узлы → важные детали. Поиск и быстрый переход к ветке детали.</p>
      <div class="hero-tags">
        <span class="tag">Детали</span>
        <span class="tag">Поиск</span>
        <span class="tag">Состав</span>
      </div>
    </div>

    <div class="hero-metrics">
      <div class="metric-card">
        <span class="metric-label">Всего узлов</span>
        <span class="metric-value">{{ summary.total }}</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Деталей</span>
        <span class="metric-value">{{ summary.details }}</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Блок</span>
        <span class="metric-value">{{ summary.blocked }}</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Ожидают</span>
        <span class="metric-value">{{ summary.waiting }}</span>
      </div>
    </div>
  </header>

  <section class="viewer-panel card" id="partial-tree">
    <div class="viewer-header">
      <div>
        <h2>Дерево выбранного объекта</h2>
        <p>Колесо — зум, drag — панорама, double click — раскрытие узла.</p>
      </div>
    </div>

    <div class="viewer-shell">
      <product-hierarchy-viewer
        class="viewer"
        [data]="treeData"
        [config]="config"
        [focusNodeId]="focusNodeId"
        (nodeSelected)="onNodeSelected($event)"
        (nodeToggled)="onNodeToggled($event)"
        (nodeUpdated)="onNodeUpdated($event)"
      ></product-hierarchy-viewer>
      <div class="viewer-hint">Наведи на узел и изучай; панорамируй колесом и захватом.</div>
    </div>
  </section>

  <aside class="details-panel card">
    <div class="details-header">
      <h2>Карточка</h2>
      <p>Статус, сроки, партия, цех, смена, себестоимость.</p>
    </div>

    <ng-container *ngIf="selectedNode as node; else emptyState">
      <div class="details-card">
        <div class="details-title">
          <div>
            <h3>{{ node.name }}</h3>
            <p class="details-path" *ngIf="selectedPath">{{ selectedPath }}</p>
          </div>
          <div class="details-tags">
            <span class="status-pill" [ngClass]="statusClass(node.status)">
              {{ getStatusLabel(node.status) }}
            </span>
            <span class="type-pill">{{ getTypeLabel(node.type) }}</span>
          </div>
        </div>

        <dl class="details-grid">
          <div>
            <dt>ID</dt>
            <dd>{{ node.id }}</dd>
          </div>
          <div>
            <dt>Статус</dt>
            <dd>{{ getStatusLabel(node.status) }}</dd>
          </div>
          <div>
            <dt>Дедлайн</dt>
            <dd>{{ formatDeadline(node.deadline) }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'plannedFinish') as plannedFinish">
            <dt>Плановая готовность</dt>
            <dd>{{ formatDeadline(plannedFinish) }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'actualFinish') as actualFinish">
            <dt>Фактическая готовность</dt>
            <dd>{{ formatDeadline(actualFinish) }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'responsible') as responsible">
            <dt>Ответственный</dt>
            <dd>{{ responsible }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'batch') as batch">
            <dt>Партия</dt>
            <dd>{{ batch }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'line') as line">
            <dt>Линия / станок</dt>
            <dd>{{ line }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'shop') as shop">
            <dt>Цех</dt>
            <dd>{{ shop }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'shift') as shift">
            <dt>Смена</dt>
            <dd>{{ shift }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'material') as material">
            <dt>Материал</dt>
            <dd>{{ material }}</dd>
          </div>
          <div *ngIf="getMeta(node, 'cost') as cost">
            <dt>Себестоимость</dt>
            <dd>{{ formatCost(cost) }}</dd>
          </div>
        </dl>
      </div>
    </ng-container>

    <ng-template #emptyState>
      <div class="details-empty">Выберите узел в дереве</div>
    </ng-template>
  </aside>

  <section class="map-panel card">
    <div class="map-header">
      <div>
        <h3>Карта главных объектов</h3>
        <p>Поиск по названию или ID. Группы по цехам.</p>
      </div>
      <input
        type="search"
        class="map-search"
        placeholder="Поиск объекта..."
        [(ngModel)]="searchTerm"
      />
    </div>

    <div class="map-group" *ngFor="let group of mainGroups">
      <div class="map-group-title">{{ group.shop }}</div>
      <div class="map-grid">
        <div class="map-item" *ngFor="let node of group.items">
          <div>
            <p class="map-title">{{ node.name }}</p>
            <p class="map-meta">{{ getTypeLabel(node.type) }} · {{ getStatusLabel(node.status) }}</p>
            <p class="map-deadline">Дедлайн: {{ formatDeadline(node.deadline) }}</p>
          </div>
          <button class="map-btn" type="button" (click)="jumpToNode(node.id)">Перейти к ветке</button>
        </div>
      </div>
    </div>
  </section>

  <section class="map-details-panel card">
    <div class="map-header">
      <div>
        <h3>Критичные детали</h3>
        <p>Листовые элементы с флагом critical=true. Поиск по названию или ID.</p>
      </div>
      <input
        type="search"
        class="map-search"
        placeholder="Поиск детали..."
        [(ngModel)]="searchTerm"
      />
    </div>

    <div class="map-group" *ngFor="let group of criticalDetailsGroups">
      <div class="map-group-title">{{ group.shop }}</div>
      <div class="map-grid">
        <div class="map-item" *ngFor="let node of group.items">
          <div>
            <p class="map-title">{{ node.name }}</p>
            <p class="map-meta">{{ getTypeLabel(node.type) }} · {{ getStatusLabel(node.status) }}</p>
            <p class="map-deadline">Дедлайн: {{ formatDeadline(node.deadline) }}</p>
          </div>
          <button class="map-btn" type="button" (click)="jumpToNode(node.id)">Перейти к ветке</button>
        </div>
      </div>
    </div>
  </section>

  <section class="viewer-panel card" id="full-tree">
    <div class="viewer-header">
      <div>
        <h2>Полное дерево цехов и объектов</h2>
        <p>Обзор всех цехов и объектов (без фильтров).</p>
      </div>
    </div>
    <div class="viewer-shell">
      <product-hierarchy-viewer
        class="viewer"
        [data]="data"
        [config]="config"
        (nodeSelected)="onNodeSelected($event)"
        (nodeToggled)="onNodeToggled($event)"
        (nodeUpdated)="onNodeUpdated($event)"
      ></product-hierarchy-viewer>
      <div class="viewer-hint">Общий контекст: цехи, машины и детали.</div>
    </div>
  </section>
</div>
